# 小宇宙深度学习助手 - 测试清单 (Testing Checklist)

## 📋 文档信息
- **版本**：v1.1
- **创建日期**：2026-01-19
- **更新日期**：2026-01-20
- **创建者**：产品经理 (James)
- **基于**：架构师 API 契约 v1.0 + PRD MVP 1.0

---

## 1. API 契约审核总结

### ✅ 审核通过项
1. **错误码设计清晰**：包含 403/404/504 等关键错误码，符合 PRD 要求
2. **词级时间戳**：数据结构包含 `start`/`end`/`text`/`speaker`，满足精准引用需求
3. **双引擎架构**：豆包（主）+ 阿里云 Qwen（备），符合容错需求
4. **LocalStorage 数据模型**：单用户设计简洁，符合 MVP 阶段需求

### ⚠️ 发现的问题与建议（✅ 已全部解决）

| 问题 | 严重程度 | 状态 | 解决方案 | 责任人 |
|------|---------|------|----------|--------|
| **缺失**：未定义爬虫超时时间 | 中 | ✅ 已解决 | 架构师已在 `05_asr_switching_spec.md` 中定义：URL 解析超时 10s | 架构师 |
| **缺失**：未定义 ASR 切换的触发条件细节 | 高 | ✅ 已解决 | 架构师已发布 `05_asr_switching_spec.md`，明确 8 种切换/不切换场景 | 架构师 |
| **缺失**：未定义 LocalStorage 容量超限处理 | 高 | ✅ 已解决 | 架构师已发布 `06_storage_management_spec.md`，定义完整的监控、提示、清理策略 | 架构师 |
| **疑问**：`corrected_at` 字段用途不明确 | 低 | ✅ 已解决 | 架构师已说明：记录 AI 纠偏时间戳 | 架构师 |
| **风险**：音频 URL 直接存储可能失效 | 中 | ✅ 已解决 | 架构师已建议：使用 HEAD 请求检测 URL 有效性 | 后端 |

### 📦 新增技术规范（2026-01-20）
- `_shared/05_asr_switching_spec.md`：ASR 双引擎切换机制（8种场景 + 超时定义 + 切换日志）
- `_shared/06_storage_management_spec.md`：LocalStorage 容量管理（3级监控 + 清理策略 + 导出功能）

---

## 2. 核心测试清单

### 2.1 URL 解析异常处理测试

#### 测试目标
验证 `/episode/parse` 接口对各种异常场景的处理能力

#### 测试用例

| 用例ID | 测试场景 | 输入 | 预期输出 | 优先级 |
|--------|---------|------|---------|--------|
| **TC-URL-001** | 正常小宇宙链接 | `https://xiaoyuzhoufm.com/episode/123456` | 返回 200 + 完整元数据 | P0 |
| **TC-URL-002** | 无效 URL 格式 | `https://google.com` | 返回 400 + `INVALID_URL` 错误码 | P0 |
| **TC-URL-003** | 空 URL | `""` 或 `null` | 返回 400 + `INVALID_URL` | P0 |
| **TC-URL-004** | 已失效的节目链接 | 删除的节目 ID | 返回 404 + `ERROR_404` | P0 |
| **TC-URL-005** | 反爬虫拦截 | 触发频率限制 | 返回 403 + `ERROR_403`（不能是通用 500） | P0 |
| **TC-URL-006** | CDN 超时 | 慢速 CDN | 返回 504 + `ERROR_504`（10s 内返回） | P1 |
| **TC-URL-007** | 非小宇宙域名 | `https://example.com/episode/123` | 返回 400 + `INVALID_URL` | P1 |
| **TC-URL-008** | 特殊字符注入 | `https://xiaoyuzhoufm.com/episode/<script>` | 返回 400 + `INVALID_URL` | P2 |

#### 验收标准
- ✅ 所有错误必须返回明确的错误码（不能是"网络错误"等模糊描述）
- ✅ 403/404/504 错误必须透传具体 HTTP 状态码
- ✅ 超时时间 ≤ 10 秒（避免用户长时间等待）
- ✅ 错误信息以"调试日志"形式展示，包含原始错误码

---

### 2.2 ASR 转录准确率验证测试

#### 测试目标
验证 ASR 转录的准确率 ≥ 80%（PRD 要求）

#### 测试播客准备（需要产品经理准备）

| 类型 | 节目名称 | 时长 | 难度 | 测试重点 |
|------|---------|------|------|----------|
| 单人播讲 | _待补充_ | 30-60 分钟 | ⭐ | 基础准确率 |
| 访谈类 | _待补充_ | 60-90 分钟 | ⭐⭐ | 说话人识别 |
| 闲聊类 | _待补充_ | 90-120 分钟 | ⭐⭐⭐ | 语速变化/口音 |
| 技术类 | _待补充_ | 60 分钟+ | ⭐⭐⭐⭐ | 专业术语准确率 |

#### 准确率计算方法

```
准确率 = (1 - 错误字数 / 总字数) × 100%

错误类型包括：
1. 错别字（同音字、形近字）
2. 漏字（漏掉的词）
3. 多字（多出来的词）
4. 乱码（完全错误的字符）
```

#### 测试用例

| 用例ID | 测试场景 | 验证方法 | 验收标准 | 优先级 |
|--------|---------|---------|---------|--------|
| **TC-ASR-001** | 短音频（10 分钟）转录 | 人工抽检 3 段，计算准确率 | 准确率 ≥ 85% | P0 |
| **TC-ASR-002** | 中等音频（60 分钟）转录 | 对比 5 个关键段落 | 准确率 ≥ 80% | P0 |
| **TC-ASR-003** | 长音频（180 分钟+）转录 | 全文分段抽检 | 准确率 ≥ 75% | P1 |
| **TC-ASR-004** | 词级时间戳准确性 | 随机选 10 个词，点击验证播放位置 | 时间偏差 < 200ms | P0 |
| **TC-ASR-005** | 说话人识别准确率 | 访谈类播客，手动标注对比 | 识别准确率 ≥ 70% | P1 |
| **TC-ASR-006** | 专业术语准确性 | 技术类播客，统计术语错误率 | 术语错误率 < 10% | P2 |
| **TC-ASR-007** | 中英文混合转录 | 中英混合播客 | 英文准确率 ≥ 70% | P2 |

#### 验收标准
- ✅ MVP 阶段综合准确率 ≥ 80%
- ✅ 词级时间戳偏差 < 200ms（用户点击文字能精准跳转）
- ✅ 转录速度 ≥ 0.5x 实时（60 分钟音频 30 分钟内完成）

---

### 2.3 双引擎切换逻辑测试

#### 测试目标
验证豆包失败后自动切换到阿里云 Qwen 的容错机制

#### 切换触发条件（✅ 架构师已明确）

> 来源：`_shared/05_asr_switching_spec.md`（2026-01-20 更新）

| 触发场景 | 是否切换 | 响应时间 | 备注 |
|---------|---------|---------|------|
| 豆包 30s 超时 | ✅ 是 | 立即切换（< 5s） | ✅ 已明确 |
| 豆包 500 错误 | ✅ 是 | 立即切换（< 5s） | ✅ 已明确 |
| 豆包 503 错误 | ✅ 是 | 立即切换（< 5s） | ✅ 已明确 |
| 豆包 504 错误 | ✅ 是 | 立即切换（< 5s） | ✅ 已明确 |
| 网络异常（连接失败） | ✅ 是 | 10s 后切换 | ✅ 已明确 |
| 豆包 400 错误 | ❌ 否 | 返回错误 | ✅ 已明确（参数错误） |
| 豆包 401 错误 | ❌ 否 | 返回错误 | ✅ 已明确（认证失败） |
| 豆包 403 错误 | ❌ 否 | 返回错误 | ✅ 已明确（权限不足） |
| 豆包 404 错误 | ❌ 否 | 返回错误 | ✅ 已明确（资源不存在） |
| 用户手动指定引擎 | - | 直接使用 | 不自动切换 |

#### 测试用例

| 用例ID | 测试场景 | 模拟方法 | 预期行为 | 优先级 |
|--------|---------|---------|---------|--------|
| **TC-SWITCH-001** | 豆包超时（30s） | 模拟豆包无响应 | 30s 后自动切换到 Qwen | P0 |
| **TC-SWITCH-002** | 豆包 500 错误 | 返回 500 错误码 | 立即切换到 Qwen | P0 |
| **TC-SWITCH-003** | 豆包 503 不可用 | 返回 503 错误码 | 立即切换到 Qwen | P0 |
| **TC-SWITCH-004** | 双引擎均失败 | 两个引擎都返回错误 | 返回 `ASR_SERVICE_UNAVAILABLE` | P0 |
| **TC-SWITCH-005** | 切换日志记录 | 触发切换 | 后台记录切换原因、时间、引擎 | P1 |
| **TC-SWITCH-006** | 用户手动选择引擎 | 请求参数指定 `engine: "qwen"` | 直接使用 Qwen，不经过豆包 | P1 |
| **TC-SWITCH-007** | 切换后进度保持 | 切换前已 50% 进度 | 继续从 50% 开始或重新开始 | P2 |

#### 验收标准
- ✅ 豆包失败后必须在 5s 内切换到 Qwen
- ✅ 切换过程必须记录详细日志（时间、原因、新引擎）
- ✅ 用户必须看到切换提示："豆包引擎无响应，已切换至备用引擎"
- ✅ 双引擎均失败时，错误码为 `ASR_SERVICE_UNAVAILABLE`（503）

---

### 2.4 数据模型验证测试

#### 测试目标
验证 LocalStorage 数据结构符合单用户 MVP 需求

#### 数据结构审核

```typescript
// Episodes 表结构
interface Episode {
  episode_id: string;        // ✅ 必需
  url: string;               // ✅ 必需
  title: string;             // ✅ 必需
  podcast_name: string;      // ✅ 必需
  cover_image: string;       // ✅ 必需
  duration: number;          // ✅ 必需
  show_notes: string;        // ✅ 必需
  audio_url: string;         // ✅ 已解决：架构师建议使用 HEAD 请求检测失效
  transcript: {
    words: Word[];           // ✅ 必需
    total_duration: number;  // ✅ 必需
    asr_engine: string;      // ✅ 必需
    word_count: number;      // ✅ 必需
    created_at: string;      // ✅ 必需
    corrected_at?: string;   // ✅ 已明确：记录 AI 纠偏时间戳（用于对比效果）
  };
  notes: Note[];             // ✅ 必需
  status: string;            // ✅ 必需
  created_at: string;        // ✅ 必需
  updated_at: string;        // ✅ 必需
}
```

#### 测试用例

| 用例ID | 测试场景 | 验证方法 | 验收标准 | 优先级 |
|--------|---------|---------|---------|--------|
| **TC-DATA-001** | 正常数据写入 | 调用 API 后检查 LocalStorage | 数据完整写入，字段齐全 | P0 |
| **TC-DATA-002** | LocalStorage 容量限制 | 写入 10 集长播客（~50MB） | 触发 `STORAGE_QUOTA_EXCEEDED` | P0 |
| **TC-DATA-003** | 数据读取性能 | 读取 1000+ 词的转录数据 | 加载时间 < 500ms | P1 |
| **TC-DATA-004** | 音频 URL 失效处理 | 模拟 CDN 链接失效 | 前端提示"音频链接已失效" | P1 |
| **TC-DATA-005** | 数据导出功能 | 点击"导出"按钮 | 导出为 Markdown 格式 | P2 |
| **TC-DATA-006** | 跨设备数据迁移 | 复制 LocalStorage 数据 | 在另一台设备导入成功 | P2 |

#### LocalStorage 容量估算

| 数据类型 | 单集大小 | 集数 | 总大小 |
|---------|---------|------|--------|
| 元数据 | ~5KB | 10 集 | ~50KB |
| 转录数据（60 分钟） | ~2MB | 10 集 | ~20MB |
| 笔记数据 | ~10KB | 10 集 | ~100KB |
| **总计** | - | 10 集 | **~20MB** |

⚠️ **风险**：LocalStorage 一般限制 5-10MB，部分浏览器可能更大
📋 **建议**：
1. 前端必须监控存储使用率
2. 达到 80% 时提示用户清理旧数据
3. 提供数据导出/备份功能

#### 验收标准
- ✅ 所有字段必须包含在写入的数据中
- ✅ LocalStorage 容量超限时必须返回明确错误
- ✅ 音频 URL 失效时有优雅降级方案
- ✅ 数据导出功能正常工作

---

## 3. 集成测试场景

### 场景 1：完整转录流程（Happy Path）

**步骤**：
1. 用户粘贴小宇宙链接
2. 后端解析链接成功（200）
3. 调用豆包 ASR 转录
4. 转录完成，写入 LocalStorage
5. 前端展示逐字稿和播放器
6. 用户点击播放，文字自动高亮

**验收标准**：
- ✅ 全流程无报错
- ✅ 端到端时间 < 40 分钟（60 分钟音频）
- ✅ 准确率 ≥ 80%

---

### 场景 2：URL 解析失败流程

**步骤**：
1. 用户粘贴已失效的节目链接
2. 后端返回 404 错误
3. 前端展示错误信息："节目链接已失效或不存在"
4. 用户重新粘贴有效链接

**验收标准**：
- ✅ 错误信息明确，不包含技术术语
- ✅ 用户能理解并重新尝试

---

### 场景 3：双引擎切换流程

**步骤**：
1. 用户粘贴小宇宙链接
2. 后端解析成功，调用豆包 ASR
3. 豆包 30s 无响应
4. 自动切换到阿里云 Qwen
5. 前端提示："豆包引擎无响应，已切换至备用引擎"
6. 转录成功完成

**验收标准**：
- ✅ 切换时间 < 5s
- ✅ 用户能看到切换提示
- ✅ 后台日志记录切换事件

---

## 4. 性能测试

### 4.1 响应时间要求

| 接口 | 目标响应时间 | 最大可接受时间 |
|------|-------------|---------------|
| `/episode/parse` | < 3s | ≤ 10s |
| `/transcript/start` | < 1s | ≤ 5s |
| `/transcript/status` | < 500ms | ≤ 2s |
| `/transcript/correct` | < 5s | ≤ 30s |

### 4.2 并发测试（MVP 阶段可选）

| 并发数 | 预期行为 | 备注 |
|--------|---------|------|
| 1 用户 1 任务 | 正常转录 | MVP 阶段 |
| 1 用户 3 任务 | 队列处理 | 后续优化 |

---

## 5. 边缘场景测试

| 场景 | 预期行为 | 优先级 |
|------|---------|--------|
| 用户粘贴时断网 | 前端提示"网络连接异常"（9001） | P0 |
| 转录中用户关闭页面 | 重新打开后能恢复进度 | P1 |
| LocalStorage 被清空 | 前端提示"本地数据已丢失，请重新转录" | P1 |
| 播客时长 > 180 分钟 | 仍能正常转录，但提示"时间较长" | P1 |
| 音频文件为空/损坏 | 返回 `INVALID_AUDIO_URL` | P0 |
| 用户快速点击多次"转录" | 前端防抖，避免重复请求 | P2 |

---

## 6. 用户体验验收（产品经理视角）

### 6.1 错误提示文案要求

- ❌ 禁止："网络错误"、"请求失败"、"系统异常"
- ✅ 允许："节目链接已失效"、"被反爬虫拦截，请稍后重试"、"音频文件无法访问"

### 6.2 加载状态反馈要求

| 操作 | 加载提示文案 |
|------|-------------|
| URL 解析中 | "正在解析节目信息..." |
| ASR 转录中 | "正在转录中，预计需要 30 分钟..." |
| AI 纠偏中 | "正在智能纠偏..." |

### 6.3 交互细节要求

- ✅ 错误信息以"调试日志"形式展示，包含原始错误码
- ✅ 转录进度实时更新（百分比 + 剩余时间）
- ✅ 长播客（90 分钟+）转录前提示"时间较长，是否继续？"

---

## 7. 测试数据准备清单

### 7.1 产品经理需要准备的测试播客

| 类型 | 节目 | 状态 |
|------|------|------|
| 单人播讲（30 分钟） | _待补充_ | ⚠️ 未准备 |
| 访谈类（60 分钟） | _待补充_ | ⚠️ 未准备 |
| 闲聊类（90 分钟） | _待补充_ | ⚠️ 未准备 |
| 技术类（60 分钟+） | _待补充_ | ⚠️ 未准备 |

### 7.2 后端需要准备的测试数据

| 数据类型 | 状态 |
|---------|------|
| 模拟 403 错误的节目链接 | ⚠️ 待准备 |
| 模拟 404 错误的节目链接 | ⚠️ 待准备 |
| 慢速 CDN 链接（测试超时） | ⚠️ 待准备 |
| 空音频文件 | ⚠️ 待准备 |

---

## 8. 问题追踪与反馈

### 8.1 发现的关键问题（✅ 已全部解决）

> 更新时间：2026-01-20
> 解决方：架构师 Architect

1. **【高优先级】** ✅ 已解决：ASR 切换触发条件已明确
   - **解决方案**：架构师已发布 `05_asr_switching_spec.md`
   - **明确内容**：
     - 30s 超时触发切换
     - 500/503/504 错误触发切换
     - 400/401/403/404 不切换
     - 网络异常 10s 后切换

2. **【高优先级】** ✅ 已解决：LocalStorage 容量超限处理已定义
   - **解决方案**：架构师已发布 `06_storage_management_spec.md`
   - **定义内容**：
     - 3 级监控：80%（警告）、95%（严重警告）、100%（阻塞）
     - 存储前预检查机制
     - 清理策略和导出功能

3. **【中优先级】** ✅ 已解决：URL 解析超时时间已补充
   - **解决方案**：在 `05_asr_switching_spec.md` 第 3 节定义
   - **明确值**：URL 解析超时 10s

4. **【低优先级】** ✅ 已解决：`corrected_at` 字段用途已说明
   - **解决方案**：架构师已说明
   - **用途**：记录 AI 纠偏时间戳（用于对比原始和纠偏后效果）

5. **【中优先级】** ✅ 已解决：音频 URL 失效检测方案已建议
   - **解决方案**：架构师建议使用 HEAD 请求检测
   - **实现**：后端在播放前检测 URL 有效性

### 8.2 对其他角色的建议（更新后）

| 角色 | 建议 | 优先级 | 状态 |
|------|------|--------|------|
| **后端** | 参考 `05_asr_switching_spec.md` 实现 ASR 切换逻辑 | 高 | 待实现 |
| **后端** | 务必记录切换日志（时间、原因、引擎） | 高 | 待实现 |
| **后端** | 实现 URL 失效检测（HEAD 请求） | 中 | 待实现 |
| **前端** | 参考 `06_storage_management_spec.md` 实现存储管理 | 高 | 待实现 |
| **前端** | 使用虚拟列表渲染超长逐字稿，避免卡顿 | 高 | 待实现 |
| **前端** | 错误信息以"调试日志"形式展示，包含原始错误码 | 高 | 待实现 |
| **UI 设计** | 加载状态反馈要清晰（预计时间、进度百分比） | 中 | 待设计 |
| **产品经理** | 准备 4 个不同类型的测试播客 | 高 | 待准备 |
| **产品经理** | 申请豆包 ASR API Key | 高 | 待申请 |

---

## 9. 测试执行计划（更新后）

### Week 1：核心功能测试
- [ ] TC-URL-001 ~ TC-URL-008（URL 解析异常处理）
- [ ] TC-ASR-001 ~ TC-ASR-004（ASR 准确率基础测试）
- [ ] TC-SWITCH-001 ~ TC-SWITCH-004（双引擎切换基础测试）

### Week 2：体验与性能测试
- [ ] TC-ASR-005 ~ TC-ASR-007（ASR 准确率高级测试）
- [ ] TC-DATA-001 ~ TC-DATA-004（数据模型验证）
- [ ] 集成测试场景 1~3

### Week 3：边缘场景与压力测试
- [ ] 边缘场景测试
- [ ] 性能测试（响应时间）
- [ ] TC-DATA-005 ~ TC-DATA-006（数据导出与迁移）

---

## 10. 成功标准（MVP 阶段）

### 技术指标
- ✅ URL 解析成功率 ≥ 90%
- ✅ ASR 转录准确率 ≥ 80%
- ✅ 双引擎切换成功率 = 100%（失败时必须有明确错误）
- ✅ 所有错误都有明确的错误码和用户友好提示

### 产品指标
- ✅ 至少完成 3 集不同类型播客的端到端测试
- ✅ 发现并记录 5-10 个可优化点
- ✅ 产品经理（James）自己愿意继续使用

---

**测试清单版本**：v1.0
**最后更新**：2026-01-19
**下一步行动**：
1. 产品经理准备测试播客列表
2. 架构师明确 ASR 切换触发条件
3. 后端准备模拟测试数据（403/404/慢速 CDN）
