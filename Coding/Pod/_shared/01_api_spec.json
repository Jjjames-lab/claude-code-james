{
  "api_spec": {
    "version": "1.0.0",
    "title": "小宇宙深度学习助手 API 规范",
    "description": "MVP 1.0 阶段 API 契约定义",
    "base_url": "http://localhost:8000/api/v1",
    "schemes": ["http", "https"]
  },
  "project_structure": {
    "backend": {
      "root": "backend/",
      "structure": {
        "app/": "应用主目录",
        "app/api/": "API 路由层",
        "app/api/routes/": "各模块路由文件",
        "app/services/": "业务逻辑层",
        "app/services/crawler.py": "小宇宙爬虫服务",
        "app/services/asr.py": "ASR 转录服务（豆包+阿里云双引擎）",
        "app/services/ai_correction.py": "GLM 纠偏服务",
        "app/models/": "数据模型定义",
        "app/models/schemas.py": "Pydantic 数据模型",
        "app/utils/": "工具函数",
        "app/utils/logger.py": "日志工具",
        "app/utils/errors.py": "错误码定义",
        "config.py": "配置文件（API keys, 超时时间等）",
        "main.py": "FastAPI 应用入口",
        "requirements.txt": "Python 依赖"
      }
    },
    "frontend": {
      "root": "frontend/",
      "structure": {
        "src/": "源代码目录",
        "src/components/": "React 组件",
        "src/components/player/": "播放器组件",
        "src/components/transcript/": "逐字稿展示组件",
        "src/components/notes/": "笔记组件",
        "src/services/": "API 服务层",
        "src/services/api.ts": "API 调用封装",
        "src/services/storage.ts": "LocalStorage 封装",
        "src/types/": "TypeScript 类型定义",
        "src/types/index.ts": "共享类型定义",
        "src/utils/": "工具函数",
        "src/utils/logger.ts": "前端日志工具",
        "src/App.tsx": "应用主组件",
        "package.json": "Node.js 依赖"
      }
    },
    "shared": {
      "root": "_shared/",
      "structure": {
        "01_api_spec.json": "API 规范（本文档）",
        "02_data_models.ts": "前后端共享的 TypeScript 类型",
        "03_error_codes.json": "统一错误码定义"
      }
    }
  },
  "endpoints": {
    "/episode/parse": {
      "method": "POST",
      "description": "解析小宇宙节目链接，获取音频地址和元数据",
      "timeout": 30,
      "request": {
        "content_type": "application/json",
        "body": {
          "url": {
            "type": "string",
            "format": "uri",
            "required": true,
            "example": "https://xiaoyuzhoufm.com/episode/123456",
            "description": "小宇宙节目链接"
          }
        }
      },
      "response": {
        "200": {
          "description": "解析成功",
          "schema": {
            "success": true,
            "data": {
              "episode_id": "123456",
              "audio_url": "https://cdn.xiaoyuzhoufm.com/episodes/xxx.mp3",
              "duration": 3600,
              "cover_image": "https://image.xiaoyuzhoufm.com/xxx.jpg",
              "show_notes": "节目介绍文字...",
              "episode_title": "第123期：深度学习实践",
              "podcast_name": "技术杂谈"
            }
          }
        },
        "400": {
          "description": "请求参数错误",
          "schema": {
            "success": false,
            "error": {
              "code": "INVALID_URL",
              "message": "无效的小宇宙链接格式"
            }
          }
        },
        "403": {
          "description": "反爬虫拦截",
          "schema": {
            "success": false,
            "error": {
              "code": "ERROR_403",
              "message": "被反爬虫机制拦截，请稍后重试"
            }
          }
        },
        "404": {
          "description": "节目不存在",
          "schema": {
            "success": false,
            "error": {
              "code": "ERROR_404",
              "message": "节目链接已失效或不存在"
            }
          }
        },
        "504": {
          "description": "超时",
          "schema": {
            "success": false,
            "error": {
              "code": "ERROR_504",
              "message": "CDN音频流拉取超时，请检查网络"
            }
          }
        }
      }
    },
    "/transcript/start": {
      "method": "POST",
      "description": "启动 ASR 转录任务（词级时间戳）",
      "timeout": 1800,
      "request": {
        "content_type": "application/json",
        "body": {
          "audio_url": {
            "type": "string",
            "format": "uri",
            "required": true,
            "description": "音频文件地址"
          },
          "episode_id": {
            "type": "string",
            "required": true,
            "description": "节目ID"
          },
          "engine": {
            "type": "string",
            "enum": ["doubao", "qwen"],
            "default": "doubao",
            "description": "ASR 引擎选择（可选）"
          }
        }
      },
      "response": {
        "200": {
          "description": "转录任务已启动",
          "schema": {
            "success": true,
            "data": {
              "task_id": "task_abc123",
              "status": "processing",
              "estimated_time": 1800,
              "engine": "doubao"
            }
          }
        },
        "400": {
          "description": "音频URL无效或无法访问",
          "schema": {
            "success": false,
            "error": {
              "code": "INVALID_AUDIO_URL",
              "message": "无法访问音频文件"
            }
          }
        },
        "503": {
          "description": "ASR 服务不可用",
          "schema": {
            "success": false,
            "error": {
              "code": "ASR_SERVICE_UNAVAILABLE",
              "message": "ASR 引擎无响应，已切换至备用引擎"
            }
          }
        }
      }
    },
    "/transcript/status": {
      "method": "GET",
      "description": "查询转录任务状态",
      "timeout": 5,
      "request": {
        "params": {
          "task_id": {
            "type": "string",
            "required": true,
            "description": "任务ID"
          }
        }
      },
      "response": {
        "200": {
          "description": "查询成功",
          "schema": {
            "success": true,
            "data": {
              "task_id": "task_abc123",
              "status": "completed|processing|failed",
              "progress": 75,
              "current_engine": "doubao|qwen",
              "result": {
                "words": [
                  {
                    "text": "深度",
                    "start": 1234,
                    "end": 1456,
                    "speaker": "Speaker 0"
                  },
                  {
                    "text": "学习",
                    "start": 1457,
                    "end": 1689,
                    "speaker": "Speaker 0"
                  }
                ],
                "total_duration": 3600,
                "asr_engine": "doubao",
                "word_count": 8500
              }
            }
          }
        },
        "404": {
          "description": "任务不存在",
          "schema": {
            "success": false,
            "error": {
              "code": "TASK_NOT_FOUND",
              "message": "转录任务不存在"
            }
          }
        }
      }
    },
    "/transcript/correct": {
      "method": "POST",
      "description": "AI 纠偏（GLM-4），修正 ASR 错误",
      "timeout": 60,
      "request": {
        "content_type": "application/json",
        "body": {
          "text_segment": {
            "type": "string",
            "required": true,
            "description": "需要纠偏的文本段落"
          },
          "context_before": {
            "type": "string",
            "required": false,
            "description": "前文上下文（约50个词）"
          },
          "context_after": {
            "type": "string",
            "required": false,
            "description": "后文上下文（约50个词）"
          }
        }
      },
      "response": {
        "200": {
          "description": "纠偏成功",
          "schema": {
            "success": true,
            "data": {
              "original_text": "第一性源理是...",
              "corrected_text": "第一性原理是...",
              "changes": [
                {
                  "from": "源理",
                  "to": "原理",
                  "type": "typo"
                }
              ]
            }
          }
        },
        "500": {
          "description": "AI 服务异常",
          "schema": {
            "success": false,
            "error": {
              "code": "AI_SERVICE_ERROR",
              "message": "GLM 服务调用失败"
            }
          }
        }
      }
    },
    "/health": {
      "method": "GET",
      "description": "健康检查接口",
      "timeout": 2,
      "response": {
        "200": {
          "description": "服务正常",
          "schema": {
            "status": "healthy",
            "timestamp": "2026-01-19T10:00:00Z",
            "services": {
              "asr_doubao": "available",
              "asr_qwen": "available",
              "ai_glm": "available"
            }
          }
        }
      }
    }
  },
  "data_models": {
    "localStorage_structure": {
      "description": "浏览器 LocalStorage 存储结构",
      "key_prefix": "pod_helper_",
      "tables": {
        "episodes": {
          "description": "已转录的节目列表",
          "storage_key": "pod_helper_episodes",
          "schema": {
            "episode_id": "string (UUID)",
            "url": "string (原始小宇宙链接)",
            "title": "string (节目标题)",
            "podcast_name": "string (播客名称)",
            "cover_image": "string (封面图URL)",
            "duration": "number (秒)",
            "show_notes": "string (节目介绍)",
            "audio_url": "string (音频URL)",
            "transcript": {
              "words": [
                {
                  "text": "string",
                  "start": "number (毫秒)",
                  "end": "number (毫秒)",
                  "speaker": "string"
                }
              ],
              "total_duration": "number",
              "asr_engine": "string",
              "word_count": "number",
              "created_at": "string (ISO 8601)",
              "corrected_at": "string (ISO 8601, 可选)"
            },
            "notes": [
              {
                "note_id": "string (UUID)",
                "timestamp": "number (毫秒)",
                "text": "string (选中的原始文本)",
                "corrected_text": "string (AI纠偏后文本, 可选)",
                "user_comment": "string (用户评论, 可选)",
                "created_at": "string (ISO 8601)"
              }
            ],
            "status": "string (pending|processing|completed|failed)",
            "created_at": "string (ISO 8601)",
            "updated_at": "string (ISO 8601)"
          }
        },
        "settings": {
          "description": "用户设置",
          "storage_key": "pod_helper_settings",
          "schema": {
            "preferred_asr_engine": "string (doubao|qwen)",
            "auto_correction_enabled": "boolean",
            "theme": "string (light|dark|auto)",
            "playback_speed": "number (默认1.0)",
            "volume": "number (默认1.0)"
          }
        }
      }
    },
    "frontend_state": {
      "description": "前端 React 应用状态管理",
      "state_structure": {
        "currentEpisode": "当前播放的节目对象",
        "playerState": {
          "isPlaying": "boolean",
          "currentTime": "number (秒)",
          "duration": "number (秒)",
          "volume": "number",
          "playbackRate": "number"
        },
        "transcriptState": {
          "words": "array (词级转录数据)",
          "currentWordIndex": "number (当前高亮的词索引)",
          "isScrolling": "boolean"
        },
        "uiState": {
          "selectedText": "string (用户选中的文字)",
          "showNoteDialog": "boolean",
          "loading": "boolean",
          "error": "string | null"
        }
      }
    }
  },
  "error_codes": {
    "description": "统一错误码定义",
    "errors": {
      "INVALID_URL": {"code": 1001, "http_status": 400, "message": "无效的URL格式"},
      "INVALID_AUDIO_URL": {"code": 1002, "http_status": 400, "message": "音频URL无法访问"},
      "ERROR_403": {"code": 1403, "http_status": 403, "message": "反爬虫拦截"},
      "ERROR_404": {"code": 1404, "http_status": 404, "message": "资源不存在"},
      "ERROR_504": {"code": 1504, "http_status": 504, "message": "请求超时"},
      "TASK_NOT_FOUND": {"code": 2001, "http_status": 404, "message": "任务不存在"},
      "ASR_SERVICE_UNAVAILABLE": {"code": 3001, "http_status": 503, "message": "ASR服务不可用"},
      "AI_SERVICE_ERROR": {"code": 4001, "http_status": 500, "message": "AI服务调用失败"},
      "STORAGE_QUOTA_EXCEEDED": {"code": 5001, "http_status": 507, "message": "浏览器存储空间不足"},
      "NETWORK_ERROR": {"code": 9001, "http_status": 503, "message": "网络连接异常"}
    }
  },
  "technical_decisions": {
    "rationale": [
      {
        "decision": "使用 FastAPI 而非 Flask",
        "reason": "FastAPI 原生支持异步、自动生成 OpenAPI 文档、类型检查，更适合现代 API 开发"
      },
      {
        "decision": "LocalStorage 而非数据库",
        "reason": "MVP 单用户场景，降低部署复杂度和成本；后续可无缝迁移至 IndexedDB 或后端数据库"
      },
      {
        "decision": "词级时间戳而非句子级",
        "reason": "提供更精准的播放定位和文字高亮体验，满足产品需求中的精准引用场景"
      },
      {
        "decision": "双引擎热备（豆包+Qwen）",
        "reason": "提高可用性，避免单点故障；自动切换机制保障转录成功率"
      },
      {
        "decision": "按需纠偏而非全局纠偏",
        "reason": "节省 AI 调用成本，用户可控，可观察纠偏效果对比"
      },
      {
        "decision": "使用 SSE 或 WebSocket 返回转录进度",
        "reason": "长耗时任务需要实时反馈，提升用户体验；避免前端轮询开销"
      }
    ]
  },
  "recommendations": {
    "for_developer": [
      "后端实现时务必记录详细日志，包括爬虫请求头、ASR 切换原因、API 响应时间等",
      "前端采用虚拟列表渲染超长逐字稿，避免 DOM 节点过多导致卡顿",
      "所有 API 调用增加超时和重试机制，提升鲁棒性",
      "开发阶段优先完成核心链路，UI 美化后续迭代"
    ],
    "for_product": [
      "准备 3-5 个不同类型的测试播客，覆盖单人播讲、访谈、闲聊等场景",
      "重点关注长播客（90分钟+）的性能表现，这是真实使用场景",
      "记录 ASR 错误模式，为后续优化 AI 纠偏策略提供数据"
    ],
    "for_design": [
      "设计清晰的加载状态反馈，让用户了解转录进度",
      "错误信息避免技术术语，使用用户友好的描述",
      "提供原始转录和纠偏后文本的对比视图，增强用户信任感"
    ]
  }
}
