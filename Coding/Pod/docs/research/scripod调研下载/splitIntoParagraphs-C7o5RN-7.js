import{q as se,s as re,v as ne,aK as ae,r as s,j as e,c as f,b7 as I,au as pe,a8 as He,aJ as _e,o as X,ae as Oe,t as B,ai as Be,aj as Ke,ak as Me,al as Y,I as C,ab as Z,aI as fe,g as qe,ac as xe,ad as Ae}from"./main-BC3yBi8Q.js";import{T as De,i as Je}from"./text-fit-DbHj2sFO.js";import{g as Ue}from"./list-COLvY6D9.js";const Ge=re("35a380aec5a96b0d67cca9ee0fd54e03c1aa1c9b11b359e94d02448dcaf23544"),at=se({method:"GET"}).handler(Ge);ne("/api/transcript/$eid")({});const ee="\\p{Latin}\\p{Greek}\\p{Cyrillic}\\p{Arabic}\\p{Hebrew}\\p{Hangul}",Ie="[\\p{Han}\\p{Hiragana}\\p{Katakana}\\p{Thai}\\p{Lao}\\p{Khmer}]",ze=`[\\p{Currency_Symbol}]?[${ee}\\d\\p{Math_Symbol}\\*\\@\\-]+(?:[\\'\\&\\%\\+${ee}\\d\\-]+)*(?:[\\.\\,\\-]['\\&\\%\\+${ee}\\d%\\p{Math_Symbol}]+)*`,ge=')）・:：、，。？！,\\.%!?》」”"’ー',be='（(《"「“',Qe=I(`([${be}]*(${ze}[${ge}]*)|[\\s\\/]+|([${be}]*${Ie}[${ge}]*))`);function Ve(T){return I.match(T,Qe,"all")}const We=({onClick:T,sentence:l,highlight:a,audio:i,daiAlign:R,durationRatio:b=1})=>{const[m,p]=s.useState();if(a&&!m){const r=Ve(l.text);r.length&&r[r.length-1].match(/[\.?!";:]$/)&&(r[r.length-1]+=" ");let d=0;const v=r.reduce((g,j,L)=>(j!==" "?(g.push({text:j,timestamp:l.timestamps?.[d]||null}),d++):g.push({text:j,timestamp:null}),g),[]);p(v)}const[c,k]=s.useState(),E=s.useRef(null),o=s.useMemo(()=>(l.timestamps?.[0]||0)-l.start,[l.timestamps,l.start]);s.useEffect(()=>{if(!a){k(v=>{if(m&&v&&v>m.length-2)return setTimeout(()=>{k(void 0),p(void 0)},200),m.length;p(void 0)}),E.current=null;return}const r=()=>{const v=o+i.currentTime*b;if(E.current&&v<E.current||!m)return;const{timestamps:g}=l;if(!g){k(1/0);return}const j=m.findIndex(L=>L.timestamp&&L.timestamp>v);E.current=m[j]?.timestamp||null,k(j<0?1/0:j)},d=()=>{E.current=null};return r(),i.addEventListener("customUpdate",r),i.addEventListener("pause",d),i.addEventListener("seeked",d),()=>{i.removeEventListener("customUpdate",r),i.removeEventListener("pause",d),i.removeEventListener("seeked",d)}},[a,i,m,l.timestamps,R,l,o]);const x=s.useRef([]);x.current.length=0;const h=s.useCallback(r=>{r!==null&&(i.currentTime=(r-o)/b,i.paused&&i.play())},[i,o]),_=s.useMemo(()=>{if(m)return e.jsx(e.Fragment,{children:m.map((r,d)=>e.jsx("span",{className:f({willchange:c!==void 0,highlight:c!==void 0&&d<c,secondary:c!==void 0&&d>=c,clickable:r.timestamp!==null}),onClick:v=>h(r.timestamp),children:r.text},d))})},[m,c,h]);return e.jsx(e.Fragment,{children:e.jsx("span",{onClick:a?void 0:T,className:f("sentence",a&&"focus"),children:_||e.jsxs("span",{children:[l.text,l.text.match(/[\.?!";:]$/)&&" "]})})})},Xe=ae.memo(We),Ye=re("faab47d8ee7065733ee900504670290d07fad2e48c7ca99d7cfdea06982743bd"),Ze=se({method:"POST"}).handler(Ye);ne("/api/bookmarks/up")({});const et=re("c62a949a2092ba138c048ea347501213fd511e41fce04c7b80db9297a4b1e70b"),tt=se({method:"POST"}).handler(et);ne("/api/bookmarks/delete")({});const te=T=>{let l="";for(const a of T){l+=a;const i=a[a.length-1];/[.,!?;:]/.test(i)&&(l+=" ")}return l},ve=ae.forwardRef(({id:T,episodeId:l,segment:a,highlight:i,audio:R,seek:b,sentenceIndex:m,segmentIndex:p,speaker:c,openSpeakerEditDialog:k,raw:E,isContinuousSpeaker:o,daiDetected:x,daiAlign:h,colorScheme:_,showIndicator:r=!0,showActions:d,durationRatio:v,selectingMode:g,enableSelectingMode:j,selected:L,toggleSelect:K,forceRender:je=!1},Ne)=>{const F=s.useRef(null);s.useImperativeHandle(Ne,()=>F.current);const ye=x&&!h||g,{isSm:Te}=pe("sm"),{isLg:M}=pe("lg"),{enableTranslate:ce,translateLanguage:q}=He()||{},[N,Se]=s.useState(!1),O=_e(),[z,ie]=s.useState(!1),[H,oe]=s.useState(!1),le=s.useRef(H);s.useEffect(()=>{le.current=H},[H]),s.useEffect(()=>{if(!O||!F.current)return;const t=F.current.getBoundingClientRect(),n={current:t.bottom>0&&t.top<window.innerHeight};s.startTransition(()=>{ie(n.current),oe(n.current)});const u=new IntersectionObserver(([P])=>{n.current=P.isIntersecting,s.startTransition(()=>{ie(n.current)});const $=()=>{le.current!==n.current&&s.startTransition(()=>{oe(n.current)}),O.removeEventListener("_scrollend",$)};O.addEventListener("_scrollend",$)},{root:O,rootMargin:"0px 0px 0px 0px",threshold:0});return u.observe(F.current),()=>{u.disconnect()}},[O]),s.useEffect(()=>{H&&Se(ce||!1)},[H,ce]);const{data:S}=X({queryKey:["episode",l,"translate",q,a.sentences.map(t=>t.text).join(" ")],queryFn:async()=>{const n=(await xe(a.sentences.map(u=>u.text),void 0,q))?.map(u=>{const P=u.detectedLanguage?.language,$=u.translations[0].to;return{text:P===$?u.translations[0].text:Z.spacingText(Ae(u.translations[0].text)),from:P,to:$}});if(!n?.every(u=>u.from===u.to))return n?.map(u=>u.text)},enabled:N,staleTime:"static",gcTime:600*1e3}),{data:A}=X({queryKey:["episode",l,"translate",q,i?.title],queryFn:async()=>{if(!i?.title)return;const t=await xe(i.title,void 0,q);return Z.spacingText(t?.[0]?.translations[0]?.text||"")},enabled:N&&!!i?.title,staleTime:"static",gcTime:600*1e3}),{data:Q,refetch:me}=X({queryKey:["episode",l,"pins"],queryFn:async()=>await Ue({data:{episodeId:l}}).then(t=>t.json()).catch(t=>{throw B.error(JSON.parse(t.message).message),t}),enabled:!1,staleTime:"static"}),y=s.useMemo(()=>{if(!Q?.length)return;let t=a.sentences[0].start,n=a.sentences[a.sentences.length-1].end;return h&&(t=h.bToA(t),n=h.bToA(n)),Q.filter(u=>u.startTime>=t&&u.startTime<n)},[Q,a.sentences,h]),[de,ue]=s.useOptimistic(y,(t,n)=>n),{checkLogin:he}=Oe(),D=s.useCallback(async()=>{if(!he())return;const n={...a,speaker:c?.name||null,sentences:a.sentences.map(({origEnd:w,origStart:G,start:Le,end:Fe,...Pe})=>({...Pe,start:G??Le,end:w??Fe}))},{start:u,end:P}=n.sentences[0],$=n.sentences.reduce((w,G)=>w.match(/[\.?!";:]$/)?w+" "+ +G.text:w+G.text,"");s.startTransition(async()=>{ue([...de||[],{createdAt:"",episodeId:"",id:NaN,updatedAt:"",userId:"",startTime:u,endTime:P,transcript:$}]),await Ze({data:{episodeId:l,startTime:u,endTime:P,transcript:$}}).catch(w=>{throw B.error(JSON.parse(w.message).message),w}),B.success("Pin added"),await me()})},[y,he]),V=s.useCallback(async()=>{y?.length&&s.startTransition(async()=>{ue([]),await tt({data:{ids:y.map(t=>t.id)}}).then(t=>{B.success("Pin removed"),me()}).catch(t=>{throw B.error(JSON.parse(t.message).message),t})})},[y]),J=s.useCallback(()=>{j?.(),K?.({segmentIndex:p,translate:N&&S?te(S.map(t=>t)):void 0})},[j,N,S,K,p]),ke=s.useMemo(()=>{if(!d||!r)return;const t=e.jsxs("div",{className:"absolute -left-2 -ml-[0.75px] cursor-pointer size-5 opacity-0 group-hover:opacity-100 transition text-(--color-highlight)",children:[e.jsx("div",{className:f("absolute h-[3px] w-3.5 mt-[6px] mx-auto left-0 right-0",m===void 0?"bg-(--color-secondary)":"bg-(--color-highlight)")}),e.jsx("div",{className:f("absolute h-[15px] w-[3px] mx-auto left-0 right-0",m===void 0?"bg-(--color-secondary)":"bg-(--color-highlight)"),children:e.jsx("div",{className:"absolute top-full w-full h-1 bg-(--color-bg)"})})]});return e.jsxs(Be,{hover:!0,modal:!1,children:[e.jsx(Ke,{asChild:!0,className:"max-sm:hidden",children:t}),e.jsxs(Me,{className:"w-fit",align:"center",forceMount:!0,children:[e.jsx(Y,{className:"gap-2",onClick:y?.length?V:D,children:y?.length?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 inline-flex justify-center",children:e.jsx(C.bookmarkSlash,{className:"h-3"})}),"Unpin"]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 inline-flex justify-center",children:e.jsx(C.bookmark,{className:"h-3"})}),"Pin"]})}),e.jsxs(Y,{className:"gap-2",onClick:J,children:[e.jsx("div",{className:"w-4 inline-flex justify-center",children:e.jsx(C.share,{className:"w-3"})}),"Share Quote"]}),e.jsxs(Y,{className:"gap-2",onClick:()=>k?.(),children:[e.jsx("div",{className:"w-4 inline-flex justify-center",children:e.jsx(C.mic,{className:"w-4"})}),"Edit Speaker"]})]})]})},[c,m,o,y,D,V,d,Te,m,j,J]),we=s.useMemo(()=>{if(d)return e.jsxs("div",{className:f("h-full flex flex-col min-h-0"),children:[e.jsx("div",{className:f(r?o||!c?"flex-1 max-h-6":c?.name?"flex-1 max-h-12":"flex-1 max-h-14":"")}),e.jsxs("div",{className:"flex align-center items-top ml-2 gap-2",children:[e.jsx("div",{className:"w-20 h-5 box-content py-2 rounded-full border font-medium border-foreground/20 flex bg-foreground/20 hover-active:bg-foreground/30 items-center justify-center text-sm cursor-pointer",onClick:y?.length?V:D,children:y?.length?e.jsxs(e.Fragment,{children:[e.jsx(C.bookmarkSlash,{className:"h-4 mr-2"}),"Unpin"]}):e.jsxs(e.Fragment,{children:[e.jsx(C.bookmark,{className:"h-4 mr-2"}),"Pin"]})}),e.jsxs("div",{className:"w-20 h-5 box-content py-2 rounded-full border font-medium border-foreground/20 flex bg-foreground/20 hover-active:bg-foreground/30 items-center justify-center text-sm cursor-pointer",onClick:J,children:[e.jsx(C.share,{className:"h-5 mr-2"}),"Share"]})]})]})},[d,D,y,J]),W=s.useMemo(()=>i&&M?e.jsx("div",{className:f("relative pl-3 sm:pl-4 md:pl-8 md:pb-0 -mr-4 md:-mr-20",o?"md:mt-6":c?.name?"mt-12":"mt-14","[shape-outside:margin-box] float-right z-1 after:content-[''] after:clear-right"),children:e.jsx("div",{className:f("rounded-[2px] bg-[hsl(var(--episode-bg-card))] font-medium antialiased leading-relaxed flex items-center justify-center"),children:e.jsx("div",{className:f(Je.className,"flex items-center justify-center p-3 w-44 sm:w-56 min-h-40 sm:min-h-56 text-[hsl(var(--episode-text))]/65 [mix-blend-mode:var(--theme-blend-mode)]"),children:e.jsxs(De,{disabled:N&&!!A,children:[Z.spacingText(i.title),N&&A&&e.jsxs("div",{className:"",children:[e.jsx("div",{className:"w-4 h-[3px] bg-current my-2"}),` ${A}`]})]})})})}):null,[i,M,o,c,A,N]),[U,Ce]=s.useState(0);s.useEffect(()=>{Ce(F.current.offsetHeight)},[z,N&&S]);const Ee=s.useMemo(()=>e.jsxs("div",{id:T,ref:F,className:f(p!==0&&"pt-8"),style:{height:U&&U},children:[!g&&W,M&&e.jsxs("div",{className:"opacity-0 inline-block",children:[!o&&c&&r&&c?.id?`${c.name??`Speaker ${c.id+1}`}`:"",e.jsx("br",{}),fe(a.sentences[0].start),e.jsx("br",{}),te(a.sentences.map(t=>t.text))]})]}),[a,W,U,z,p,c,M,g]),$e=s.useMemo(()=>({"--color-bg":`var(--color-${c?.id||"null"}-bg)`,"--color-secondary":`var(--color-${c?.id||"null"}-secondary)`,"--color-highlight":`var(--color-${c?.id||"null"})`}),[c]),Re=s.useCallback(()=>{K?.({segmentIndex:p,translate:!L&&N&&S?te(S.map(t=>t)):void 0})},[p,L,K,N,S]);return!U||z||je?e.jsxs("div",{ref:F,id:T,style:$e,children:[p!==0&&r&&e.jsx("div",{className:f("h-8 w-[3px] max-sm:-ml-4",o&&"bg-(--color-bg)")}),e.jsxs("div",{className:f("relative group",r&&"max-sm:-ml-4 max-sm:pl-[1.1rem] pl-8"),children:[r&&e.jsx("div",{className:f("w-[3px] h-full absolute left-0 top-0 transition",m===void 0?"bg-(--color-bg)":"bg-(--color-highlight)")}),!g&&W,!g&&ke,g&&e.jsx("div",{className:f("absolute -inset-1 left-3 sm:left-7 rounded-lg border border-dashed cursor-pointer hover-active:bg-foreground/5 transition",L?"border-foreground/20 bg-foreground/15! border-solid":"border-foreground/20"),onClick:Re}),e.jsx(qe,{extra:!g&&we,intersectionAndNotScrolling:H,className:f(g&&"pointer-events-none"),children:e.jsxs("div",{className:"relative",children:[!o&&c&&r&&e.jsx("div",{className:"pointer-events-auto sticky left-0 leading-none cursor-pointer align-top mb-2.5 inline-block text-(--color-highlight)",onClick:()=>k?.(),children:c.name?e.jsx(e.Fragment,{children:e.jsx("span",{className:"",children:c?.name})}):e.jsx(C.mic,{})}),r&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"-mt-1.5"}),e.jsxs("div",{className:"sticky h-3 inline-flex gap-2 left-0 font-mono text-xs text-(--color-highlight)",children:[de?.length?e.jsx(C.bookmark,{className:"h-3 shrink-0 relative -bottom-px opacity-60"}):null,e.jsx("div",{className:"opacity-30 relative flex",children:fe(a.sentences[0].start)})]}),e.jsx("br",{})]}),e.jsx("div",{className:"transcript-segment-sentences",children:a.sentences.map((t,n)=>e.jsx(Xe,{audio:R,sentence:t,highlight:ye?!1:m===n,onClick:()=>{b({start:t.start,end:t.end,segmentIndex:p,sentenceIndex:n},!0)},daiAlign:h,durationRatio:v},n))}),N&&S&&e.jsx("div",{className:"inline-block p-2 px-3 bg-neutral-900 mt-3 rounded",children:a.sentences?.map((t,n)=>e.jsxs("span",{className:f("text-translate opacity-60 antialiased hover-hover:hover:opacity-95 cursor-pointer",m===n&&"text-(--color-highlight) opacity-90"),onClick:()=>{b({start:t.start,end:t.end,segmentIndex:p,sentenceIndex:n},!0)},children:[S[n],S[n]?.match(/[\.?!";:]$/)&&" "]},n))})]})})]})]}):Ee});ve.displayName="Segment";const ct=ae.memo(ve),it=(T,l=180,a=400,i=300)=>{let R=[],b=[];const m=I("[\\p{Han}\\p{Hiragana}\\p{Katakana}\\p{Thai}\\p{Lao}\\p{Khmer}\\p{Hangul}]","g"),p=I("[\\p{Latin}\\p{Greek}\\p{Cyrillic}\\p{Arabic}\\p{Hebrew}]","g");function c(o){const x=(o.match(m)||[]).length,h=(o.match(p)||[]).length;return x>h*2?"characterScript":h>x*2?"spacedScript":"mixed"}function k(o){if(o.length===0)return i;const x=o.map(v=>v.text).join(""),h=c(x);if(h==="characterScript")return l;if(h==="spacedScript")return a;const _=(x.match(m)||[]).length,r=(x.match(p)||[]).length,d=_+r;return d===0?i:Math.round(_/d*l+r/d*a)}function E(o){return o.reduce((x,h)=>x+h.text.length,0)}return T.forEach((o,x)=>{const h=k([...b,o]);E(b)+o.text.length>h&&x!==0?(R.push(b),b=[o]):b.push(o)}),b.length&&R.push(b),R};export{ct as S,te as a,tt as d,at as g,it as s};
