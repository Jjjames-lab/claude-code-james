import{aK as J,U as B,r as o,w as G,aa as V,a8 as W,a9 as p,o as X,j as s,c as v,I as U,aI as $,ab as R,ac as Y,ad as Z,q as ee,s as te,v as se,G as ie,t as re,aL as ae,at as ne}from"./main-BC3yBi8Q.js";import{T as D}from"./text-with-timestamp-WPuPihg6.js";import{u as oe}from"./useSuspenseQuery-DxWLkiby.js";const de=({className:m,paragraph:a,seek:w,showSummary:g,setShowSummary:j,currentTimestamp:l,allTimestamps:d,audioDuration:F,episode:E,audioToggle:T,setCurrentTimestamp:q})=>{const P=()=>{j(!g)},{audio:y,status:b,daiAlign:A}=B(),[u,L]=o.useState(),z=G(),{scroller:O}=V(),{enableTranslate:C,translateLanguage:_,getRouteChangeScrollTop:I}=W()||{},h=o.useMemo(()=>a.children.sort((t,e)=>p(t.time)-p(e.time)),[a.children]),{data:x}=X({queryKey:["episode",E.id,"translate",_,"chapter",a.summary],queryFn:async()=>{const e=(await Y([a.title,a.summary,...h.map(c=>c.title)],void 0,_))?.map(c=>{const f=c.detectedLanguage?.language,S=c.translations[0].to;if(f!==S)return R.spacingText(Z(c.translations[0].text))});return e?{title:e[0],summary:e[1],children:h.map((c,f)=>{const S=e[f+2];if(S)return{...c,title:S}}),time:a.time}:void 0},enabled:C,refetchOnMount:!1,refetchOnReconnect:!1,refetchOnWindowFocus:!1});o.useEffect(()=>{const t=()=>{const e=y.currentTime;if(!l){L(void 0);return}let n;d.indexOf(l)===d.length-1?n={start:y.duration,time:""}:n=d[d.indexOf(l)+1],!(e>=n.start)&&n&&L(Number(((e-l.start)/(n.start-l.start)).toFixed(4)))};if(t(),!(b!=="playing"&&b!=="paused"))return y.addEventListener("timeupdate",t),()=>{y.removeEventListener("timeupdate",t)}},[y,d,l,b]);const N=o.useMemo(()=>{const t=d.find(k=>k.time===a.time);let e;d.indexOf(t)===d.length-1?e=F?{start:F,time:""}:void 0:e=d[d.indexOf(t)+1];const n=e?.start,c=t.start;if(!n)return[1];const f=h.map(k=>p(k.time));f[0]=c,f.push(n);const S=n-c;return f.reduce((k,Q,H,K)=>(H===K.length-1||k.push((K[H+1]-Q)/S),k),[])},[a,d,F]),M=o.useMemo(()=>{if(u!==void 0)return N.findLastIndex((t,e)=>{const n=N.slice(0,e).reduce((c,f)=>c+f,0);return u>n})},[u,N]),r=o.useMemo(()=>N.map((t,e)=>{const n=N.slice(0,e).reduce((f,S)=>f+S,0);let c=u&&u>n?(u-n)/t:0;return c>1&&(c=1),s.jsx("div",{className:v("h-full bg-[hsl(var(--episode-vibrant))]/10 overflow-clip rounded-[1px] transition",M===e&&"bg-[hsl(var(--episode-vibrant))]/25"),style:{flex:t},children:c>0&&s.jsx("div",{className:v("w-full h-full bg-[hsl(var(--episode-vibrant))] transition-all duration-75"),style:{width:`${c*100}%`}})},e)}),[u,N,M]),i=o.useCallback(t=>{let e=p(t);t===h[0].time&&(e=p(a.time)),w(e),q({start:p(a.time),time:a.time})},[w,a,q]);return s.jsxs("div",{className:v("mb-10 relative group/card antialiased",m),id:a.time,children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("div",{className:v("flex items-baseline leading-none w-fit opacity-50 font-bold text-lg text-[hsl(var(--episode-vibrant))] cursor-pointer ","hover-active:opacity-100",l&&"opacity-100"),onClick:()=>l?T():i(a.time),children:l?s.jsxs(s.Fragment,{children:[(b==="playing"||b==="seeking")&&s.jsx(U.audioPlaying,{className:"size-4 shrink-0 mr-2"}),s.jsx("span",{className:"",children:b==="playing"||b==="paused"?$(y.currentTime):$(l.start)})]}):a.time}),s.jsx("div",{className:v("size-9 bg-[hsl(var(--episode-bg-50))] border border-foreground/5 font-medium flex items-center justify-center rounded-full","text-[hsl(var(--episode-vibrant))]/50 cursor-pointer","hover-active:bg-[hsl(var(--episode-vibrant))]/50 hover-active:text-[hsl(var(--episode-bg-25))]"),onClick:async()=>{const t=I();await z.navigate({to:"/episode/$eid/transcript",params:{eid:E.id},hash:l?void 0:a.time,mask:{to:"/episode/$eid/transcript",params:{eid:E.id},hash:void 0}}),O?.scrollTo({top:t,behavior:"instant"})},children:s.jsx(U.arrow,{className:"size-3.5"})})]}),s.jsxs("div",{className:v("relative px-3 leading-relaxed pt-4 mt-2.5 text-foreground/80 bg-[hsl(var(--episode-bg-25))] rounded-xl",l&&"shadow-[0_0_0_4px_hsl(var(--episode-vibrant)/0.3)]"),children:[s.jsxs("h2",{className:"text-base relative -top-[6px] leading-relaxed mix-blend-plus-lighter subpixel-antialiased",children:[R.spacingText(a.title),C&&x?.title&&s.jsx("div",{className:"opacity-70 mix-blend-plus-lighter",children:` ${x.title}`})]}),s.jsx("div",{className:"relative h-2 mt-1 mb-2 rounded-full overflow-clip",children:s.jsx(s.Fragment,{children:s.jsx("div",{className:"absolute inset-0 flex gap-[2px]",children:r})})}),h.map((t,e)=>s.jsx("div",{className:v("group -mx-3 px-3 py-1.5 hover-active:bg-[hsl(var(--episode-vibrant))]/5 cursor-pointer"),onClick:()=>i(t.time),children:s.jsxs("div",{className:"flex w-fit not-first:mt-2 last:-mb-0.5 ",children:[s.jsx("div",{className:v("text-[hsl(var(--episode-vibrant))] bg-[hsl(var(--episode-vibrant))]/25 inline-flex items-center justify-center size-5 rounded text-xs relative font-medium cursor-pointer opacity-70 transition mr-3","group-hover-active:opacity-100",M===e&&"bg-[hsl(var(--episode-vibrant))] text-[hsl(var(--episode-bg-25))]"),children:e+1}),s.jsxs("div",{className:v("flex-1 -mt-1 transition",M===e&&"text-[hsl(var(--episode-vibrant))]"),children:[R.spacingText(t.title),C&&x?.children[e]?.title&&s.jsx("div",{className:"opacity-70 mix-blend-plus-lighter",children:` ${x.children[e]?.title}`})]})]})},e)),s.jsx("div",{onClick:P,className:"text-xs uppercase leading-none text-[hsl(var(--episode-vibrant))] opacity-50 hover-active:opacity-100 cursor-pointer pt-3 pb-3",children:g?"Hide Summary":"Show Summary"}),s.jsxs("div",{className:v("h-0 transition-all duration-300 opacity-0 overflow-hidden",g&&"h-[calc-size(auto,size)] opacity-100"),children:[s.jsx("hr",{className:"border-primary/10"}),s.jsx(D,{className:"leading-relaxed text-primary/70 rounded -mt-1 py-3 animate-fade-in duration-200",text:R.spacingText(a.summary),seek:i,timeIndexMap:Object.fromEntries(h.map((t,e)=>[t.time,e]))}),C&&x?.summary&&s.jsx(D,{className:"leading-relaxed text-primary/70 opacity-70 pb-3 rounded animate-fade-in duration-200 mix-blend-plus-lighter",text:R.spacingText(x.summary),seek:i,timeIndexMap:Object.fromEntries(h.map((t,e)=>[t.time,e]))})]})]})]})},ce=J.memo(de),le=te("15d226fa1e369f4d3df34547eaf043194084159814cda2d99a9a6a0848cb4877"),ue=ee({method:"GET"}).handler(le);se("/api/summary/$eid")({});function xe(){return s.jsx(me,{})}const me=()=>{const{episode:m}=W(),{eid:a}=ie({from:"/episode/$eid"}),{data:w}=oe({queryKey:["episode",a,"summary"],queryFn:async()=>await ue({data:{episodeId:a}}).then(r=>r.json()).catch(r=>{throw re.error(JSON.parse(r.message).message),r}),staleTime:"static"}),{daiAlign:g,audioDuration:j}=B({episode:m})||{},l=o.useMemo(()=>{if(!g)return w.chapters;const r=/\[(\d{1,2}:\d{2}:\d{2}|\d{2}:\d{2})\]/g;return w.chapters.map(i=>{if(typeof i=="string")return i;const t=g.aToB(p(i.time));return t>(j||1/0)?null:{...i,time:$(t),children:i.children.map(e=>{const n=g.aToB(p(e.time));return n>(j||1/0)?null:{...e,time:$(n)}}).filter(e=>!!e),summary:i.summary.replace(r,e=>{const n=g.aToB(p(e.slice(1,-1)));return n>(j||1/0)?"":`[${$(n)}]`})}}).filter(i=>i?typeof i=="string"?!0:i.children.length>0:!1)},[w,g,j]),{audio:d,playEpisode:F,status:E,episode:T,toggleEpisode:q}=B()||{},P=o.useCallback(r=>{m&&F(m,r)},[m,F]),[y,b]=o.useState({}),A=o.useCallback(r=>{b(i=>({...i,[r]:!i[r]}))},[]),u=o.useMemo(()=>l.flatMap(r=>typeof r=="string"?[]:{start:p(r.time),time:r.time}),[l]),[L,z]=o.useState(),{setCurrentId:O}=ae();o.useEffect(()=>{if(!m||!T||T.id!==m.id)return;const r=()=>{const i=u.findLast(t=>t.start<=d.currentTime);z(i),O(i?.time)};if(!(E!=="playing"&&E!=="paused"))return r(),d.addEventListener("timeupdate",r),()=>{d.removeEventListener("timeupdate",r)}},[d,u,T,m,E,O]);const{scrollTo:C}=W()||{},_=G(),{hash:I,pathname:h}=ne(),[x,N]=o.useState(!1);o.useEffect(()=>{N(!0)},[]),o.useEffect(()=>{if(!h.startsWith(`/episode/${a}/chapters`))return;if(I&&/^(\d{1,2}:)?\d{2}:\d{2}$/.test(I)){const i=p(I);_.navigate({to:"/episode/$eid/chapters",params:{eid:a},search:e=>e,hash:"",replace:!0});const t=u.findLast(e=>e.start<=i);t&&requestAnimationFrame(()=>{C?.(t.time,{offset:-window.innerHeight*.2,smooth:!!x})});return}if(x||T?.id!==m?.id||!d.currentTime)return;const r=u.findLast(i=>i.start<=d.currentTime);r&&requestAnimationFrame(()=>C?.(r.time,{offset:-window.innerHeight*.2,smooth:!1}))},[I,x,h,m,T]),o.useEffect(()=>()=>{O(void 0)},[O]);const M=o.useMemo(()=>l.map((r,i)=>typeof r=="string"?null:s.jsx(ce,{episode:m,paragraph:r,seek:P,showSummary:y[i]||!1,setShowSummary:()=>A(i),allTimestamps:u,audioDuration:j,currentTimestamp:L?.time===r.time?L:void 0,audioToggle:q,setCurrentTimestamp:z},i)),[m,w,y,A,P,L,u,j]);return s.jsx("div",{className:"-mt-[11px] antialiased",children:M})};export{xe as component};
