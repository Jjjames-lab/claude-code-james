# 架构师工作日志

## 最新工作记录

### [2026-01-21 23:00] 任务：前端联调前合规性排查

**状态**：✅ 已完成

**任务描述**：
在 Go 后端排查完成后，继续对前端代码进行全面合规性排查，确保前后端能够正常联调

**排查范围**：
- [x] 前端类型定义检查
- [x] API 契约一致性检查
- [x] Mock 数据检查
- [x] 组件代码检查

**发现的问题**：
- 🔴 严重问题：
    - F-001：类型定义与 API 契约不一致（`startTime`/`endTime` vs `start`/`end`）
  ⚠️ 警告问题：
    - F-002：缺少 API 调用代码实现
    - F-003：Mock 数据 words 字段为空

**产出物**：
- 文件：`_shared/21_frontend_compliance_fix_guide.md`（前端修复指南）

**对其他角色的建议**：
- 给前端：优先修复 F-001 类型定义问题（预计 5 分钟），否则无法解析后端响应
- 给前端：建议实现 F-002 API 调用代码（预计 30 分钟），以便与后端联调
- 给前端：建议补充 F-003 Mock 数据（预计 5 分钟），以便测试逐字稿显示

**前端修复状态**：
- [x] F-001：类型定义已修复（2026-01-21 23:30）
- [x] F-002：API 服务层已完成（pod-studio/src/services/api.ts，约 230 行）
- [x] F-003：Mock 数据已填充

**下一步任务**：
- [ ] 等待后端工程师修复 Go 后端的 3 个严重问题
- [ ] 前后端都修复完成后，可开始联调测试

---

### [2026-01-21 22:45] 任务：Go 后端联调前合规性排查

**状态**：✅ 已完成

**任务描述**：
在联调上线前对 Go 后端进行全面合规性排查，检查 API 契约、数据模型、错误处理等是否符合工作约束

**排查范围**：
- [x] Go 后端代码结构检查
- [x] API 接口契约一致性检查
- [x] 错误处理规范检查
- [x] 命名规范检查
- [x] 配置管理检查

**发现的问题**：
- 🔴 严重问题：
    - G-001：数据模型字段命名不一致（`start_time`/`end_time` vs `start`/`end`）
    - G-002：API 路径与契约不一致（`/crawler/parse` vs `/episode/parse`）
    - G-003：爬虫响应字段缺失（缺少 `episode_title`、`podcast_name`）
  ⚠️ 警告问题：
    - G-004：默认端口不一致（8080 vs 8000）
    - G-005：缺少部分 API 端点（`/transcript/status`、`/transcript/correct`）

**产出物**：
- 文件：`_shared/20_go_backend_compliance_fix_guide.md`（修复指南）
- 代码规范检查结果：大部分符合规范

**对其他角色的建议**：
- 给后端：优先修复 3 个严重问题（预计 15 分钟），然后再进行联调
- 给前端：修复完成后，确认 API 调用地址和字段名称
- 给产品：决定是否实现 `/transcript/status` 和 `/transcript/correct` 端点

**下一步任务**：
- [ ] 等待用户分配下一个任务

---

### [2026-01-21 17:00] 任务：Go 后端迁移架构设计（🔥 最高优先级）

**状态**：✅ 已完成

**任务描述**：
设计从 Python FastAPI 到 Go 的完整迁移方案，包括技术选型、项目结构、API 规范、数据流设计和迁移阶段规划

**完成内容**：
- [x] 研究现有 Python FastAPI 代码结构
- [x] 技术选型：Gin（Web）、Viper（配置）、Zap（日志）、resty（HTTP）、MinIO SDK
- [x] Go 项目结构设计（internal/、pkg/、cmd/ 标准布局）
- [x] API 接口规范定义（统一响应格式、错误码）
- [x] 数据流设计（ASR 转录流程、错误处理流程）
- [x] 5 个迁移阶段规划（共 9-10 天）
- [x] 代码规范与约束定义
- [x] 风险评估与缓解措施

**产出物**：
- 文件：`_shared/19_go_backend_migration_architecture.md`（约 800 行）

**技术决策**：
1. Web 框架选择 Gin
   - 理由：性能好（比 FastAPI 快 10x+）、API 友好、社区成熟、中间件丰富
2. 配置管理选择 Viper
   - 理由：支持多种配置源、类型安全、支持热更新
3. 日志库选择 Zap
   - 理由：零分配日志（性能极高）、结构化日志
4. 爬虫服务保留 Python
   - 理由：Playwright 在 Python 中更成熟，Go 的 browser automation 库不如 Playwright 稳定
   - 方案：Go 服务通过 HTTP 调用 Python 爬虫微服务

**迁移阶段规划**：
- 阶段 1：基础框架搭建（2天）- Gin 服务 + 中间件 + Docker
- 阶段 2：ASR 服务迁移（3天）- 豆包/阿里云客户端 + 多引擎服务
- 阶段 3：存储服务集成（2天）- MinIO 本地存储
- 阶段 4：爬虫服务处理（1-2天）- 保留 Python，HTTP 通信
- 阶段 5：联调和上线（1天）- 前端联调 + 性能测试 + 灰度发布

**对其他角色的建议**：
- 给后端：根据此文档开始 Go 后端实现，优先完成阶段 1 和阶段 2
- 给前端：API 接口保持兼容，无需修改
- 给 DevOps：准备 MinIO（Docker Compose）和 Go 服务的部署环境

**下一步任务**：
- [ ] 等待用户分配下一个任务

---

### [2026-01-21 16:00] 任务：生成前后端修复指南

**状态**：✅ 已完成

**任务描述**：
为前后端工程师生成详细的问题修复指南，解决开发合规性排查发现的问题

**完成内容**：
- [x] 生成后端工程师修复指南（3个问题，含2个严重问题）
- [x] 生成前端工程师修复指南（3个警告问题）
- [x] 确定命名风格决策（统一使用 snake_case）
- [x] 提供完整的修复步骤和代码示例
- [x] 提供测试验证方法

**产出物**：
- 文件：`_shared/backend_fix_guide.md`（后端修复指南）
- 文件：`_shared/frontend_fix_guide.md`（前端修复指南）

**技术决策**：
- 决策：统一使用 snake_case（下划线命名）作为 API 契约标准
- 理由：与现有 API 契约保持一致，后端 Python 更自然，前端转换成本更低

**对其他角色的建议**：
- 给后端：优先修复两个严重问题（环境变量命名、错误码格式），否则无法正确启动 ASR
- 给前端：修改类型定义以匹配 API 契约，特别是 TranscriptWord 结构

**下一步任务**：
- [ ] 等待用户分配下一个任务

---

### [2026-01-21 15:30] 任务：开发合规性排查

**状态**：✅ 已完成

**任务描述**：
检查前后端工程师的开发是否符合工作约束（API 契约、代码合规等）

**排查范围**：
- [x] 前端工程师约束检查
- [x] 后端工程师约束检查
- [x] API 契约遵循情况
- [x] 数据模型一致性
- [x] 错误码使用规范

**发现的问题**：
- 🔴 严重问题：后端环境变量命名不符合 ASR 配置文档
- 🔴 严重问题：错误码格式与 API 契约不一致（数字 vs 字符串）
- ⚠️ 警告：前端类型定义使用驼峰命名，与 API 契约下划线不一致
- ⚠️ 警告：前端 TranscriptWord 多了 id 字段
- ⚠️ 警告：健康检查响应缺少 timestamp 字段

**产出物**：
- 排查报告已反馈给用户（见上方）

**技术决策**：
- 需要前后端协商命名规范（驼峰 vs 下划线）
- 后端必须修复环境变量命名才能正确读取配置

**对其他角色的建议**：
- 给后端：优先修复两个严重问题（环境变量命名、错误码格式）
- 给前端：与后端协商命名风格，统一使用下划线或驼峰

**下一步任务**：
- [ ] 等待用户分配下一个任务

---

### [2026-01-21 14:30] 任务：多引擎兜底架构设计

**状态**：✅ 已完成

**任务描述**：
设计多引擎 ASR 兜底架构，参考 PushToTalk 项目的实战实现，提供完整的技术规范供后端实现。

**完成内容**：
- [x] 设计接口抽象层（ASREngine 基类）
- [x] 定义三种竞速策略（Fallback / Race / Mixed）
- [x] 设计配置管理规范（环境变量 + Pydantic）
- [x] 定义错误处理规范（自定义异常 + 错误码映射）
- [x] 提供性能优化建议（连接池、并发控制、缓存）
- [x] 提供 Python 完整实现框架
- [x] 定义日志与监控方案

**产出物**：
- 文件：`_shared/09_multi_engine_architecture.md`（多引擎架构设计，约 700 行）
- 内容：架构图、接口定义、三种策略、配置管理、错误处理、性能优化

**参考来源**：
- PushToTalk 项目：`src-tauri/src/asr/race_strategy.rs`
- PushToTalk 项目：`src-tauri/src/asr/http/doubao.rs`
- PushToTalk 项目：`src-tauri/src/asr/http/qwen.rs`

**技术决策**：
- 决策1：使用抽象基类定义统一接口
- 理由：支持动态添加新引擎，提高可扩展性
- 决策2：提供三种策略供选择（Fallback / Race / Mixed）
- 理由：Fallback 节省配额，Race 速度最快，Mixed 综合最优
- 决策3：推荐使用 Mixed 策略（PushToTalk 实战验证）
- 理由：主引擎带重试 + 备用引擎并行，兼顾成功率和速度
- 决策4：使用 Pydantic Settings 管理配置
- 理由：类型安全、环境变量自动映射、验证

**对其他角色的建议**：
- 给后端：参考 PushToTalk 的 Rust 实现，使用 Python 重写三种策略
- 给后端：务必实现结构化日志和 Prometheus 指标监控
- 给产品：豆包试用期只有 20 小时，建议监控额度使用情况

**下一步任务**：
- [ ] 等待用户分配下一个任务

---

### [2026-01-20 11:30] 任务：回应产品经理审核问题 + 工作汇报

**状态**：✅ 已完成

**任务描述**：
1. 回应产品经理在测试清单中发现的 5 个 API 契约问题
2. 补充 ASR 切换机制技术规范
3. 补充 LocalStorage 容量管理策略
4. 汇报当前进展、下一步计划、需要其他角色的支持

**完成内容**：
- [x] 补充 ASR 双引擎切换触发条件（8 种场景明确定义）
- [x] 补充 URL 解析超时时间（10 秒）
- [x] 补充 LocalStorage 容量超限处理策略（监控、提示、清理）
- [x] 补充音频 URL 失效检测建议
- [x] 补充 corrected_at 字段说明
- [x] 定义 Phase 2 技术深化任务清单（5 个方向）
- [x] 明确需要其他角色提供的支持

**产出物**：
- 文件：`_shared/05_asr_switching_spec.md`（ASR 切换机制技术规范，约 400 行）
- 文件：`_shared/06_storage_management_spec.md`（LocalStorage 容量管理策略，约 350 行）
- 说明：完整回应了产品经理审核的 5 个问题

**遇到的问题**：
- 问题1：产品经理审核发现 API 契约有 5 个不明确的地方
- 解决方案：创建两个补充文档详细说明

**技术决策**：
- 决策1：ASR 切换触发条件明确为 8 种场景（4 种切换，4 种不切换）
- 理由：后端需要明确的实现标准，避免歧义
- 决策2：URL 解析超时设置为 10 秒
- 理由：避免用户长时间等待，同时给爬虫足够时间
- 决策3：LocalStorage 容量监控分 3 级（80% 警告、95% 严重警告、100% 阻塞）
- 理由：提前通知用户，避免写入失败时才发现问题

**对其他角色的建议**：
- 给产品经理：需要提供 4 个测试播客、确认优先级、准备测试数据
- 给后端：根据 ASR 切换规范实现容错逻辑、确认超时时间
- 给前端：实现存储监控和清理功能、考虑虚拟列表优化

**下一步任务**：
- [ ] 等待用户确认 Phase 2 优先级（长音频处理 / API 优化 / WebSocket）
- [ ] 根据用户选择设计对应的技术方案

---

### [2026-01-19 18:49] 任务：定义 API 契约和项目结构

**状态**：✅ 已完成

**任务描述**：
根据 PRD 文档，定义小宇宙深度学习助手的 API 规范、项目目录结构和数据模型。

**完成内容**：
- [x] 定义前后端项目目录结构
- [x] 定义 5 个 API 接口（URL解析、ASR转录、AI纠偏、健康检查、状态查询）
- [x] 定义 LocalStorage 数据结构
- [x] 定义错误码体系（10个错误码）
- [x] 记录 6 个技术决策及理由

**产出物**：
- 文件：`_shared/01_api_spec.json`
- 说明：完整的 API 契约文档，472行，包含请求/响应格式、数据模型、错误码定义

**遇到的问题**：
- 问题1：文件输出位置错误（创建在 `架构师 Architect/_shared/`）
- 解决方案：已移动到正确位置 `_shared/01_api_spec.json`

**技术决策**：
- 决策1：使用 FastAPI 而非 Flask
- 理由：FastAPI 原生支持异步、自动生成 OpenAPI 文档、类型检查
- 决策2：LocalStorage 而非数据库
- 理由：MVP 单用户场景，降低部署复杂度
- 决策3：词级时间戳而非句子级
- 理由：提供更精准的播放定位和文字高亮
- 决策4：双引擎热备（豆包+Qwen）
- 理由：提高可用性，避免单点故障
- 决策5：按需纠偏而非全局纠偏
- 理由：节省 AI 成本，用户可控
- 决策6：使用 SSE 推送转录进度
- 理由：长耗时任务需要实时反馈

**对其他角色的建议**：
- 给后端：务必记录详细日志，包括爬虫请求头、ASR 切换原因
- 给前端：采用虚拟列表渲染超长逐字稿，避免 DOM 节点过多
- 给产品：准备 3-5 个不同类型的测试播客，重点关注长播客性能

**下一步任务**：
- [x] 等待用户分配下一个任务

---

## 工作历史

（暂无历史记录）
